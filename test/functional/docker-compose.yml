services:
  odyssey:
    extra_hosts:
      - "ip4-localhost:127.0.0.1"
    ulimits:
      core: # sudo sysctl -w kernel.core_pattern=/var/cores/core-%e-%p-%t
        soft: -1
        hard: -1
    privileged: true
    init: true
    build:
      dockerfile: ./test/functional/Dockerfile
      context: ../../ # odyssey root dir
      target: "${ODYSSEY_TEST_TARGET:-functional-entrypoint}"
      args:
        odyssey_build_type: "${ODYSSEY_FUNCTIONAL_BUILD_TYPE:-build_release}"
        odyssey_cc: "${ODYSSEY_CC:-gcc}"
    command: ["-k", "${ODYSSEY_FUNCTIONAL_TESTS_SELECTOR:-}"]
    environment:
      CMAKE_BUILD_TYPE: "${CMAKE_BUILD_TYPE:-Debug}"
      ASAN_OPTIONS: "log_path=/asan-output.log fast_unwind_on_malloc=0" # abort_on_error=1
      TSAN_OPTIONS: "log_path=/tsan-output.log"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/cores:/var/cores
    ports:
      - "2222:22"
      - "7777:7777"
    networks:
      od_net:
        ipv4_address: 192.168.233.15
  openldapr:
    image: "osixia/openldap:1.5.0"
    networks:
      od_net:
        ipv4_address: 192.168.233.16

networks:
  od_net:
    name: odyssey_od_net
    driver: bridge
    ipam:
      driver: default
      config:
       - subnet: 192.168.233.0/24
         #       - gateway: 192.168.233.1
